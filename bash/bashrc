## fix terminal/tmux for undercurl support - squigly line for errors
# see https://dev.to/jibundit/undercurl-display-on-neovim-and-tmux-with-iterm2-3pi0
export TERM="xterm-256color"
tic -x ~/.dotfiles/config/xterm-256color.ti

## PATH ##
export PATH="/opt/homebrew/sbin:$PATH"
export PATH="/opt/homebrew/bin:$PATH"
export PATH="$PATH:/opt/nvim-linux64/bin"
export PATH="$PATH:/Library/NessusAgent/run/sbin"
export PATH="$PATH:$HOME/.dotfiles/scripts"

## Update Dotfiles ##
if [ -d "$HOME/.dotfiles" ]; then
    if [ ! -f "$HOME/.dotfiles/.ts" ]; then
        touch "$HOME/.dotfiles/.ts"
    fi
    # if file is older than one hour
    if find ~/.dotfiles/.ts -mmin 60 | grep ts; then
        git -C "$HOME/.dotfiles" pull >/dev/null
    fi
fi

## BLE.SH ##
# https://github.com/akinomyoga/ble.sh/wiki/Manual-%C2%A71-Introduction
# install ble.sh if needed
if [ ! -f "$HOME/.local/share/blesh/ble.sh" ]; then
    git clone --recursive --depth 1 --shallow-submodules https://github.com/akinomyoga/ble.sh.git /tmp/ble.sh
    make -C /tmp/ble.sh install PREFIX="$HOME/.local"
fi
# source ble.sh and config
[[ $- == *i* ]] &&
    source "$HOME/.local/share/blesh/ble.sh" --rcfile "$HOME/.blerc" --noattach

set -o vi # use vi mode for bash keys
# set -o emacs # use emacs mode (default) for bash keys

# use the latest version of nvim on debian
if [[ -f /etc/debian_version ]]; then
    export PATH="$PATH:/opt/nvim-linux64/bin"
fi

## EXPORT ##
export EDITOR=nvim
export OBJC_DISABLE_INITIALIZE_FORK_SAFETY="YES"

if command -v security &>/dev/null; then
    OPENAI_API_KEY=$(security find-generic-password -s openai -a autocomplete -w)
else
    OPENAI_API_KEY=""
fi
export OPENAI_API_KEY

## Functions ##
source "$HOME/.dotfiles/bash/functions"

## GO config ##
export GOPATH="$HOME/go"
export GOCACHE="$HOME/.cache/go"
export GOMAXPROCS=$(nproc)
export PATH="$PATH:$GOPATH/bin"

## ALIAS ##
# common
alias ls='ls -F --color=auto'
alias ll='ls -larthF'
alias gs="git status"
alias ks='kubectl -n kube-system'
# alias grep='rg'
alias cat='batcat -pp'
alias diff='colordiff -y --suppress-common-lines'
alias lg='lazygit'
alias x='exit'
alias ta='tmux a -t'
alias v='nvim'
alias jq='jq -C'
alias less='less -R'
alias gb='go build -v'
alias rb='exec bash' # reload bash
alias gpl='git pull'
alias gph='git push'
alias sshkeygen='ssh-keygen -t ed25519 -a 100'
alias makepasswd='openssl passwd -6 --salt'
alias tput.sh='~/.dotfiles/scripts/tput.sh'
alias colors='/usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/gawin/bash-colors-256/master/colors)"'
alias node_elig='nomad node eligibility # -self -enable -disable'

# macos
if [ "$(uname)" == "Darwin" ]; then
    export SHELL="/opt/homebrew/bin/bash"
    ulimit -n 65536 # ansible needs to open lots of files
    alias update='$HOME/.dotfiles/scripts/update_macos.sh'
    alias start_meeting="/Users/jared/Documents/scripts/redlight.sh"
    alias stop_meeting="/Users/jared/Documents/scripts/bluelight.sh"
    alias tacc="ssh -i $HOME/.ssh/tacc_id_ras jsc3642@stampede2.tacc.utexas.edu"
    alias reset_network="sudo route -n flush && sudo dscacheutil -flushcache"
    alias tastyfish="ssh jared@tastyfish.local"
    alias crawfish="ssh -i $HOME/.ssh/jcampbell7899@utexas.edu.pem -p6137 jared@crawfish.infosec.utexas.edu"
    alias pssh="ssh -o StrictHostKeyChecking=false -J void-jumpbox-01 "
    alias notes="vim $HOME/Documents/Notes/documentation/notes.md"
    alias ansible_site="/opt/ansible/site.yaml"
    alias ip_lookup="/opt/chomp/.venv/bin/python3 /opt/chomp/tsc_tools/tsc_tools.py -o --ip_lookup "
    alias ip_bq="/opt/chomp/.venv/bin/python3 /opt/chomp/tsc_tools/tsc_tools.py -o --ip_quarantine"
    alias mac_bq="/opt/chomp/.venv/bin/python3 /opt/chomp/tsc_tools/tsc_tools.py -o --mac_quarantine"
    alias nomad_ots="ssh -t nomad-client-001 'podman run -it --rm --network=ots_network --dns=1.1.1.1 --cap-add=NET_RAW -v /opt/chomp:/opt/chomp:ro -v /opt/chompout:/opt/chompout:rw void-registry.infosec.utexas.edu/utexasiso-default /bin/bash'"
    alias nmap_ots="ssh -J void-jumpbox-03 -t nomad-client-001 'sudo podman run -it --rm --network=ots_network --dns=1.1.1.1 --cap-add=NET_RAW -v /opt/chomp:/opt/chomp:ro -v /opt/chompout:/opt/chompout:rw void-registry.infosec.utexas.edu/utexasiso-scavenger:production /bin/bash'"
    alias nomad_git='ansible nomad_clients,nomad_baremetal -b -m shell -a "git -C /opt/nomad pull; git -C /opt/chomp pull; git -C /opt/chomptest pull"'
    alias refresh_dns='$HOME/.dotfiles/scripts/refresh_dns.sh'
    alias pansible='$HOME/.config/scripts/pansible.sh'
    alias ans='source .venv/bin/activate.fish && source setup/.env.jared'
    alias du='dust -r'
    alias df='duf'
    alias ls='lsd -AF'
    alias cat='bat -pp'
    alias vha="./site.yaml --limit=load_balancers --tags=haproxy"
    alias flush_dns="sudo killall -HUP mDNSResponder"
    alias rsync='/opt/homebrew/bin/rsync'
    # alias vpn="$HOME/.dotfiles/.venv/bin/python3 $HOME/.dotfiles/scripts/openconnect-sso.py"
    alias vpn='cd ~/.dotfiles/scripts/ocgo && ./ocgo || ./reset_dns.sh'
    alias sgpt="$HOME/.dotfiles/.venv/bin/python3 -m sgpt"
    alias gac='ai_git_commit'
    alias alf='ansible-lint --fix'

fi

# linux
if [ "$(uname)" == "Linux" ]; then
    alias test_ots_net='sudo podman run -it --rm --network=ots_network --dns=1.1.1.1 --cap-add=NET_RAW -v /opt/chomp:/opt/chomp:ro -v /opt/chompout:/opt/chompout:rw void-registry.infosec.utexas.edu/utexasiso-scavenger:production curl ifconfig.me'
    alias test_cluster_net='sudo podman run -it --rm --network=cluster_network --cap-add=NET_RAW -v /opt/chomp:/opt/chomp:ro -v /opt/chompout:/opt/chompout:rw void-registry.infosec.utexas.edu/utexasiso-scavenger:production ping -c1 128.83.185.40'
fi

# attach to tmux on SSH
if [[ -z $TMUX ]] && [[ -n $SSH_TTY ]]; then
    exec tmux new-session -A -s main
fi

# load direnv
eval "$(direnv hook bash)"

# needs to be at end of file
[[ ! ${BLE_VERSION-} ]] || ble-attach
